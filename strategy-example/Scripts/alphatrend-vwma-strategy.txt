// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// author © KivancOzbilgic (AlphaTrend Indicator)
// author © [Your Name] (Strategy Implementation)
//@version=5
strategy("AlphaTrend VWMA Strategy", shorttitle="AT-VWMA", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ===== AlphaTrend Indicator Parameters =====
coeff = input.float(1, 'Multiplier', step=0.1, group="AlphaTrend")
AP = input(40, 'Common Period', group="AlphaTrend")
src = input(close, title="Price Source", group="AlphaTrend")
novolumedata = input(title='Change calculation (no volume data)?', defval=false, group="AlphaTrend")

// ===== HMA Parameters =====
hma_length = input.int(120, "HMA Length", minval=5, group="HMA")

// ===== VWMA Parameters =====
vwma_length = input.int(20, "VWMA Length", minval=1, group="VWMA")
vwma_src = input(close, "VWMA Source", group="VWMA")

// ===== Strategy Parameters =====
take_profit = input.float(6, "Take Profit (%)", minval=0.1, step=0.1, group="Strategy Parameters")
stop_loss = input.float(2, "Stop Loss (%)", minval=0.1, step=0.1, group="Strategy Parameters")
enable_reversal = input.bool(true, "Enable Reversal Signals", group="Strategy Parameters")

// ===== AlphaTrend Calculation =====
ATR = ta.sma(ta.tr, AP)
upT = low - ATR * coeff
downT = high + ATR * coeff
AlphaTrend = 0.0
AlphaTrend := (novolumedata ? ta.rsi(src, AP) >= 50 : ta.mfi(hlc3, AP) >= 50) ? 
                 upT < nz(AlphaTrend[1]) ? nz(AlphaTrend[1]) : upT : 
                 downT > nz(AlphaTrend[1]) ? nz(AlphaTrend[1]) : downT

// Store current and previous AlphaTrend values for comparison
alpha_current = AlphaTrend
alpha_previous = AlphaTrend[2]

// Determine AlphaTrend direction
alpha_trend_bullish = alpha_current > alpha_previous
alpha_trend_bearish = alpha_current < alpha_previous

// ===== HMA Calculation =====
hma = ta.hma(close, hma_length)

// ===== VWMA Calculation =====
vwma = ta.vwma(vwma_src, vwma_length)

// ===== Plotting =====
color1 = AlphaTrend > AlphaTrend[2] ? #00E60F : AlphaTrend < AlphaTrend[2] ? #80000B : AlphaTrend[1] > AlphaTrend[3] ? #00E60F : #80000B
k1 = plot(AlphaTrend, color=color.new(#0022FC, 0), linewidth=3, title="AlphaTrend")
k2 = plot(AlphaTrend[2], color=color.new(#FC0400, 0), linewidth=3, title="AlphaTrend Previous")
fill(k1, k2, color=color1)

// Plot HMA (keeping for reference but not using in entry signals)
plot(hma, color=color.new(color.purple, 0), linewidth=2, title="HMA")

// Plot VWMA
plot(vwma, title="VWMA", color=color.new(#2962FF, 0), linewidth=2)

// ===== Entry Signals =====
// Long signal: Blue AlphaTrend > Red AlphaTrend AND price < VWMA
// HMA condition removed
long_signal = alpha_trend_bullish and close > vwma

// Short signal: Red AlphaTrend > Blue AlphaTrend AND price > VWMA
// HMA condition removed  
short_signal = alpha_trend_bearish and close < vwma

// ===== Strategy Execution =====
// Calculate SL and TP prices based on percentages
long_sl = strategy.position_avg_price * (1 - stop_loss/100)
long_tp = strategy.position_avg_price * (1 + take_profit/100)
short_sl = strategy.position_avg_price * (1 + stop_loss/100)
short_tp = strategy.position_avg_price * (1 - take_profit/100)

// Strategy entry logic
if (strategy.position_size == 0)
    // Enter new positions when no position is open
    if (long_signal)
        strategy.entry("Long", strategy.long)
    else if (short_signal)
        strategy.entry("Short", strategy.short)
else
    // Handle existing positions
    if (strategy.position_size > 0) // Long position
        // Exit on TP or SL
        strategy.exit("Long Exit", "Long", limit=long_tp, stop=long_sl)
        
        // Exit on reversal signal if enabled
        if (enable_reversal and short_signal)
            strategy.close("Long")
            strategy.entry("Short", strategy.short)
    else // Short position
        // Exit on TP or SL
        strategy.exit("Short Exit", "Short", limit=short_tp, stop=short_sl)
        
        // Exit on reversal signal if enabled
        if (enable_reversal and long_signal)
            strategy.close("Short")
            strategy.entry("Long", strategy.long)

// ===== Plotting Signals =====
plotshape(long_signal and strategy.position_size <= 0 ? low * 0.99 : na, title="Long Signal", style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small)
plotshape(short_signal and strategy.position_size >= 0 ? high * 1.01 : na, title="Short Signal", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small)

// ===== Alert Conditions =====
alertcondition(long_signal, title="Long Signal", message="AlphaTrend VWMA: Long Signal!")
alertcondition(short_signal, title="Short Signal", message="AlphaTrend VWMA: Short Signal!")